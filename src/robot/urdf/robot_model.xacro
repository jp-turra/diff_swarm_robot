<?xml version="1.0"?>
<robot name="model" xmlns:xacro="http://ros.org/wiki/xacro">
    <!-- Materials -->
    <material name="red">
        <color rgba="1.0 0.0 0.0 1.0"/>
    </material>

    <material name="green">
        <color rgba="0.0 1.0 0.0 1.0"/>
    </material>

    <material name="blue">
        <color rgba="0.0 0.0 1.0 1.0"/>
    </material>

    <material name="yellow">
        <color rgba="1.0 1.0 0.0 1.0"/>
    </material>

    <material name="white">
        <color rgba="1.0 1.0 1.0 1.0"/>
    </material>
    
    <material name="aqua_blue">
        <color rgba="0.0 1.0 1.0 1.0"/>
    </material>

    <!-- Xacro properties -->
    <xacro:property name="robot_name" value="robot"/>
    <xacro:property name="spwan_height" value="0.05"/>

    <!-- Xacro macros -->
    <xacro:macro name="rectangle_inertia" params="mass width length">
        <inertia 
            ixx="${width * width * mass / 12.0}" 
            ixy="0.0"
            ixz="0.0"
            iyy="${length * length * mass / 12.0}" 
            iyz="0.0"
            izz="${((length * length) + (width * width)) * mass / 12.0}"
        />
    </xacro:macro>

    <xacro:macro name="cylinder_inertia" params="mass radius height">
        <inertia 
            ixx="${(3*radius*radius + height*height) * mass / 12.0}" 
            ixy="0.0"
            ixz="0.0"
            iyy="${(3*radius*radius + height*height) * mass / 12.0}" 
            iyz="0.0"
            izz="${mass*radius*radius / 2.0}"
        />
    </xacro:macro>

    <xacro:macro name="sphere_inertia" params="mass radius">
        <inertia 
            ixx="${(2/5) * (mass*radius*radius)}" 
            ixy="0.0"
            ixz="0.0"
            iyy="${(2/5) * (mass*radius*radius)}" 
            iyz="0.0"
            izz="${(2/5) * (mass*radius*radius)}"
        />
    </xacro:macro>

    <!-- LINKS -->
    <link name="base_link">
        <visual>
            <geometry>
                <!-- Length, Width, Height in meters -->
                <box size="0.1 0.1 0.05"/>
            </geometry>
            <!-- Position in meters and rotation in radians -->
            <origin xyz="0.0 0.0 ${spwan_height}" rpy="0.0 0.0 0.0"/>
            <material name="green"/>
        </visual>

        <collision>
            <origin xyz="0.0 0.0 ${spwan_height}" rpy="0.0 0.0 0.0"/>
            <geometry>
                <box size="0.1 0.1 0.05"/>
            </geometry>
        </collision>

        <inertial>
            <origin xyz="0.0 0.0 ${spwan_height}" rpy="0.0 0.0 0.0"/>
            <mass value="0.5"/>
            <xacro:rectangle_inertia mass="0.5" width="0.1" length="0.1"/>
        </inertial>
    </link>

    <link name="left_wheel">
        <visual>
            <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
            <geometry>
                <cylinder radius="0.04" length="0.03"/>
            </geometry>
            <material name="aqua_blue"/>
        </visual>

        <collision>
            <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
            <geometry>
                <cylinder radius="0.04" length="0.03"/>
            </geometry>
        </collision>

        <inertial>
            <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
            <mass value="0.1"/>
            <xacro:cylinder_inertia mass="0.1" radius="0.04" height="0.03"/>
        </inertial>
    </link>

    <link name="right_wheel">
        <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
        <visual>
            <geometry>
                <cylinder radius="0.04" length="0.03"/>
            </geometry>
            <material name="aqua_blue"/>
        </visual>

        <collision>
            <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
            <geometry>
                <cylinder radius="0.04" length="0.03"/>
            </geometry>
        </collision>

        <inertial>
            <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
            <mass value="0.1"/>
            <xacro:cylinder_inertia mass="0.1" radius="0.04" height="0.03"/>
        </inertial>
    </link>

    <link name="caster_wheel">
        <visual>
            <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
            <geometry>
                <sphere radius="0.01"/>
            </geometry>
            <material name="yellow"/>
        </visual>

        <collision>
            <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
            <geometry>
                <sphere radius="0.01"/>
            </geometry>
        </collision>

        <inertial>
            <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
            <mass value="0.1"/>
            <xacro:sphere_inertia mass="0.1" radius="0.01"/>
        </inertial>
    </link>

    <!-- JOINTS -->
    <joint name="left_wheel_joint" type="continuous">
        <parent link="base_link"/>
        <child link="left_wheel"/>
        <axis xyz="0.0 0.0 1.0"/>
        <origin xyz="-0.03 0.07 0.05" rpy="-1.57 0.0 0.0"/>
    </joint>

    <joint name="right_wheel_joint" type="continuous">
        <parent link="base_link"/>
        <child link="right_wheel"/>
        <axis xyz="0.0 0.0 1.0"/>
        <origin xyz="-0.03 -0.07 0.05" rpy="-1.57 0.0 0.0"/>
    </joint>

    <joint name="caster_wheel_joint" type="continuous">
        <parent link="base_link"/>
        <child link="caster_wheel"/>
        <axis xyz="1.0 1.0 1.0"/>
        <origin xyz="0.03 0.0 0.015" rpy="0.0 0.0 0.0"/>
    </joint>

    <!-- Gazebo Plugins -->
    <gazebo>
        <plugin name="ignition::gazebo::systems::DiffDrive" 
                filename="libignition-gazebo-diff-drive-system.so">
            <!-- Wheels -->
            <left_joint>left_wheel_joint</left_joint>
            <right_joint>right_wheel_joint</right_joint>

            <!-- Kinematics -->
            <wheel_separation>0.13</wheel_separation>
            <wheel_radius>0.04</wheel_radius>

            <!-- Output -->
            <odom_publish_frequency>5</odom_publish_frequency>

            <topic>cmd_vel</topic>
        </plugin>
    </gazebo>

</robot>
